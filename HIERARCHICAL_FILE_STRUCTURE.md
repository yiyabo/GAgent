# 层级文件结构系统

## 📁 自动文件组织

系统现在会根据任务层级自动生成文件结构，每个任务的输出都会保存到对应的位置。

### 文件结构规则

```
results/
├── [ROOT任务名]/                    # ROOT任务创建根目录
│   ├── [COMPOSITE任务1]/            # COMPOSITE任务创建子目录
│   │   ├── [ATOMIC任务1].md        # ATOMIC任务生成md文件
│   │   ├── [ATOMIC任务2].md
│   │   └── ...
│   ├── [COMPOSITE任务2]/
│   │   ├── [ATOMIC任务3].md
│   │   └── ...
│   └── ...
```

### 示例

假设你创建了一个研究任务：

**用户输入：**
> "帮我创建一个任务，我想要研究一下双曲空间应用在蛋白质结构生成"

**系统会创建：**

1. **ROOT任务:** "研究双曲空间应用在蛋白质结构生成"
   - 📁 目录: `results/研究双曲空间应用在蛋白质结构生成/`

2. **COMPOSITE任务们:** (系统自动拆分)
   - "文献综述" → 📁 `results/研究双曲空间应用在蛋白质结构生成/文献综述/`
   - "方法分析" → 📁 `results/研究双曲空间应用在蛋白质结构生成/方法分析/`
   - "应用案例" → 📁 `results/研究双曲空间应用在蛋白质结构生成/应用案例/`

3. **ATOMIC任务们:** (进一步拆分COMPOSITE)
   - "双曲空间基础理论" → 📄 `results/研究.../文献综述/双曲空间基础理论.md`
   - "蛋白质结构建模" → 📄 `results/研究.../方法分析/蛋白质结构建模.md`
   - "成功案例分析" → 📄 `results/研究.../应用案例/成功案例分析.md`

### 实际文件树示例

```
results/
└── 研究双曲空间应用在蛋白质结构生成/
    ├── 文献综述/
    │   ├── 双曲空间基础理论.md
    │   ├── 蛋白质结构建模综述.md
    │   └── 现有方法对比.md
    ├── 方法分析/
    │   ├── 黎曼几何应用.md
    │   ├── 双曲嵌入技术.md
    │   └── 结构预测算法.md
    └── 应用案例/
        ├── alphafold集成.md
        ├── 成功案例分析.md
        └── 性能评估.md
```

## 🤖 LLM如何理解

### LLM会自动：

1. **识别任务类型**
   - ROOT: 顶层任务
   - COMPOSITE: 可以进一步分解的任务
   - ATOMIC: 最小执行单元（实际产出内容的任务）

2. **生成文件路径**
   - 根据任务的parent_id和root_id自动构建层级路径
   - 自动清理任务名称为安全的文件名（去除特殊字符）

3. **自动保存输出**
   - **所有ATOMIC任务**执行完成后自动保存到对应的.md文件
   - COMPOSITE和ROOT任务只创建目录，不生成文件

## 🎯 使用方式

### 方式1: 通过前端对话（推荐）

直接在对话中说：
```
"帮我创建一个任务，研究XXX"
```

系统会：
1. 创建ROOT任务
2. 自动分解为COMPOSITE任务
3. 进一步分解为ATOMIC任务
4. 执行ATOMIC任务时**自动生成md文件**

### 方式2: 明确要求生成文件

如果想确保生成文件，可以在任务描述中明确说明：
```
"研究深度学习，并将结果保存为markdown文件"
```

### 方式3: 检查生成的文件

任务执行完成后，检查`results/`目录：
```bash
ls -R results/
```

或者在前端查看生成的文件列表。

## 🔧 技术实现

### 核心组件

1. **`app/utils/task_path_generator.py`**
   - `get_task_file_path(task, repo)`: 根据任务层级生成文件路径
   - `ensure_task_directory(path)`: 确保目录存在
   - `slugify(text)`: 清理任务名称为安全文件名

2. **`app/execution/executors/tool_enhanced.py`**
   - `_default_report_path()`: 使用层级路径生成器
   - 自动检测ATOMIC任务并启用文件保存
   - 使用file_operations工具写入文件

3. **任务元数据**
   - `task_type`: root | composite | atomic
   - `parent_id`: 父任务ID
   - `root_id`: 根任务ID

### 自动保存逻辑

```python
# ATOMIC任务自动保存
if task_type == "atomic":
    # 自动生成层级路径
    file_path = get_task_file_path(task, repo)
    # 例如: results/root_name/composite_name/atomic_name.md
    
    # 保存LLM生成的内容
    execute_tool("file_operations", {
        "operation": "write",
        "path": file_path,
        "content": llm_output
    })
```

## 📋 注意事项

1. **文件名清理**
   - 特殊字符会被移除或替换
   - 空格转换为下划线
   - 限制长度为50字符

2. **目录自动创建**
   - 父目录会自动创建
   - 使用`parents=True, exist_ok=True`

3. **文件覆盖**
   - 重复执行同一任务会覆盖之前的文件
   - 如需保留历史，建议添加版本控制

4. **路径安全**
   - 所有路径都经过安全验证
   - 白名单目录检查
   - 防止目录遍历攻击

## 🚀 快速测试

```bash
# 1. 创建一个测试任务（通过前端）
"帮我创建一个任务：编写一个关于机器学习的入门教程"

# 2. 等待任务执行完成

# 3. 检查生成的文件
ls -R results/

# 应该看到类似：
# results/编写机器学习入门教程/
#   ├── 基础概念/
#   │   ├── 什么是机器学习.md
#   │   └── 核心算法介绍.md
#   ├── 实践示例/
#   │   └── 简单分类任务.md
#   └── ...
```

## 💡 优势

1. **自动化**: 无需手动管理文件结构
2. **有组织**: 清晰的层级结构，易于导航
3. **可追溯**: 每个任务的输出都有明确的位置
4. **智能**: LLM自动理解任务层级关系
5. **可扩展**: 支持任意深度的任务分解

## 🔮 未来改进

- [ ] 添加文件版本控制
- [ ] 支持自定义文件格式（PDF, HTML等）
- [ ] 生成索引文件（README.md）
- [ ] 文件内容预览和编辑
- [ ] 导出为压缩包
